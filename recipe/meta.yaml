{% set name = "onnx" %}
{% set version = "1.6.0" %}

package:
  name: {{ name|lower }}
  version: {{ version }}

source:
  url: https://github.com/onnx/onnx/archive/v{{ version }}.tar.gz
  sha256: a725df7c1bbed3456794c9fb8c4a5443ba0d3496f96ef3685a4625dc947de855
  patches:
    - patch-cmake.patch

build:
  number: 2
  script:
    - set "CL=/wd4244 /wd4251 /DPROTOBUF_USE_DLLS"  # [win]
    - set "CMAKE_GENERATOR_PLATFORM="  # [win]
    - set "CMAKE_GENERATOR=Visual Studio 14 2015"  # [win]
    - set "PYTHON_LIBRARY=%LIBRARY_LIB%"  # [win]
    - set "PYTHON_INCLUDE_DIR=%LIBRARY_INC%"  # [win]
    - set "CMAKE_PREFIX_PATH=%LIBRARY_PREFIX%"   # [win]
    - set "PYTHON_EXECUTABLE=%PYTHON%"
    - set "PYTHON_LIBRARIES=%LIBRARY_LIB%"  # [win]
    - set "ONNX_ML=1"  # [win]
    - export ONNX_ML=1  # [unix]
    # build script looks at this, but not set on
    - export CONDA_PREFIX="$PREFIX"  # [unix]
    - python -m pip install --no-deps --ignore-installed --verbose .
  entry_points:
    - check-model = onnx.bin.checker:check_model
    - check-node = onnx.bin.checker:check_node
    - backend-test-tools = onnx.backend.test.cmd_tools:main
  skip: true  # [win and vc<14]

requirements:
  build:
    - {{ compiler('c') }}
    - {{ compiler('cxx') }}
    - cmake
  host:
    - python
    - pip
    - protobuf
    - libprotobuf
    - pytest-runner
    - ninja
    - pybind11
    - numpy
  run:
    - python
    - protobuf
    - libprotobuf
    - {{ pin_compatible('numpy') }}
    - six
    - typing  # [py<35]
    - typing-extensions >=3.6.2.1

test:
  imports:
    - onnx
  commands:
    - check-model --help
    - check-node --help
    - backend-test-tools --help
    - conda inspect linkages -p $PREFIX {{ name }}  # [unix]
    - conda inspect objects -p $PREFIX {{ name }}   # [osx]

about:
  home: https://github.com/onnx/onnx/
  license: MIT
  license_family: MIT
  license_file: LICENSE
  summary: Open Neural Network Exchange library
  description: |
    Open Neural Network Exchange (ONNX) is the first step toward an open
    ecosystem that empowers AI developers to choose the right tools as their
    project evolves. ONNX provides an open source format for AI models. It
    defines an extensible computation graph model, as well as definitions of
    built-in operators and standard data types. Initially we focus on the
    capabilities needed for inferencing (evaluation).

extra:
  recipe-maintainers:
    - ezyang
    - marcelotrevisani
