From 41b2d9bde1d74507602bbc467affaaaadf712ac2 Mon Sep 17 00:00:00 2001
From: Mark Harfouche <mark.harfouche@gmail.com>
Date: Sat, 27 Dec 2025 21:54:58 -0500
Subject: [PATCH 5/8] link privately and abseil

---
 CMakeLists.txt | 17 ++++++++++-------
 1 file changed, 10 insertions(+), 7 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index b63a9c07c..5e0a65c9b 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -413,7 +413,7 @@ if(MSVC)
   )
 endif()
 add_library(onnx_proto)
-target_link_libraries(onnx_proto PUBLIC $<BUILD_INTERFACE:onnx_proto_object>)
+target_link_libraries(onnx_proto PRIVATE $<BUILD_INTERFACE:onnx_proto_object>)
 if(ONNX_ML)
   target_compile_definitions(onnx_proto PUBLIC ONNX_ML=1)
 endif()
@@ -427,17 +427,19 @@ target_include_directories(onnx_object PUBLIC
   $<BUILD_INTERFACE:${CMAKE_CURRENT_BINARY_DIR}>)
 target_include_directories(onnx_object PUBLIC $<BUILD_INTERFACE:${ONNX_ROOT}>)
 add_onnx_global_defines(onnx_object)
-target_link_libraries(onnx_proto_object PUBLIC ${LINKED_PROTOBUF_TARGET})
-target_link_libraries(onnx_object PUBLIC ${LINKED_PROTOBUF_TARGET})
+target_link_libraries(onnx_proto_object PRIVATE ${LINKED_PROTOBUF_TARGET})
+target_link_libraries(onnx_object PRIVATE ${LINKED_PROTOBUF_TARGET})
 foreach(ABSL_USED_TARGET IN LISTS protobuf_ABSL_USED_TARGETS)
   if(TARGET ${ABSL_USED_TARGET})
-    target_link_libraries(onnx_proto_object PUBLIC ${ABSL_USED_TARGET})
-    target_link_libraries(onnx_object PUBLIC ${ABSL_USED_TARGET})
+    target_link_libraries(onnx_proto_object PRIVATE ${ABSL_USED_TARGET})
+    target_link_libraries(onnx_object PRIVATE ${ABSL_USED_TARGET})
   endif()
 endforeach()
 add_library(onnx)
-target_link_libraries(onnx PUBLIC $<BUILD_INTERFACE:onnx_object> $<BUILD_INTERFACE:onnx_proto_object>)
-target_link_libraries(onnx PUBLIC $ENV{PREFIX}/Library/lib/abseil_dll.lib)
+target_link_libraries(onnx PRIVATE $<BUILD_INTERFACE:onnx_object> $<BUILD_INTERFACE:onnx_proto_object>)
+if(WIN32)
+target_link_libraries(onnx PRIVATE $ENV{PREFIX}/Library/lib/abseil_dll.lib)
+endif()
 target_include_directories(onnx PUBLIC $<INSTALL_INTERFACE:include>)
 if(ONNX_ML)
   target_compile_definitions(onnx PUBLIC ONNX_ML=1)
@@ -471,6 +473,7 @@ if(ONNX_BUILD_PYTHON)
   if(CMAKE_COMPILER_IS_GNUCXX AND CMAKE_CXX_COMPILER_VERSION VERSION_LESS 9.0)
     target_link_libraries(onnx_cpp2py_export PRIVATE "-lstdc++fs")
   endif()
+  target_link_libraries(onnx_cpp2py_export PRIVATE ${LINKED_PROTOBUF_TARGET})
 endif()
 
 if(MSVC)
-- 
2.51.0

